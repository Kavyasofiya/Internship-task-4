<!DOCTYPE html>
<html>
<head>
    <title>Group Chat App</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; border-radius: 5px; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .tab { display: inline-block; padding: 10px; cursor: pointer; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ Group Chat App</h1>
        
        <div>
            <div class="tab active" onclick="showTab('auth')">Auth</div>
            <div class="tab" onclick="showTab('groups')">Groups</div>
            <div class="tab" onclick="showTab('messages')">Messages</div>
        </div>
        
        <!-- Auth Tab -->
        <div id="auth" class="tab-content active section">
            <h3>Register</h3>
            <input id="regUsername" placeholder="Username">
            <input id="regEmail" placeholder="Email">
            <input id="regPassword" type="password" placeholder="Password">
            <button onclick="register()">Register</button>
            
            <h3>Login</h3>
            <input id="loginEmail" placeholder="Email">
            <input id="loginPassword" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            
            <div id="authResult" class="result"></div>
        </div>
        
        <!-- Groups Tab -->
        <div id="groups" class="tab-content section">
            <h3>Create Group</h3>
            <input id="groupName" placeholder="Group Name">
            <textarea id="groupDesc" placeholder="Description"></textarea>
            <button onclick="createGroup()">Create Group</button>
            
            <h3>My Groups</h3>
            <button onclick="listGroups()">List My Groups</button>
            <div id="groupList"></div>
            
            <h3>Toggle Admin-Only</h3>
            <input id="adminGroupId" placeholder="Group ID">
            <button onclick="toggleAdminOnly()">Toggle</button>
            
            <div id="groupResult" class="result"></div>
        </div>
        
        <!-- Messages Tab -->
        <div id="messages" class="tab-content section">
            <h3>Send Message</h3>
            <input id="msgGroupId" placeholder="Group ID">
            <textarea id="messageContent" placeholder="Message"></textarea>
            <button onclick="sendMessage()">Send Message</button>
            
            <h3>Get Messages</h3>
            <input id="getMsgGroupId" placeholder="Group ID">
            <button onclick="getMessages()">Get Messages</button>
            
            <div id="messageList"></div>
            <div id="messageResult" class="result"></div>
        </div>
        
        <div class="section">
            <h3>API Status</h3>
            <button onclick="checkHealth()">Check Health</button>
            <div id="healthResult" class="result"></div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token') || '';
        
        function showResult(elementId, text, isError = false) {
            const el = document.getElementById(elementId);
            el.innerHTML = text;
            el.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // API Functions
        async function register() {
            const data = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value
            };
            
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (res.ok) {
                token = result.token;
                localStorage.setItem('token', token);
                showResult('authResult', `‚úÖ Registered! Token: ${token}`, false);
            } else {
                showResult('authResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function login() {
            const data = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (res.ok) {
                token = result.token;
                localStorage.setItem('token', token);
                showResult('authResult', `‚úÖ Logged in as ${result.user.username}`, false);
            } else {
                showResult('authResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function createGroup() {
            if (!token) {
                showResult('groupResult', '‚ùå Please login first', true);
                return;
            }
            
            const data = {
                name: document.getElementById('groupName').value,
                description: document.getElementById('groupDesc').value
            };
            
            const res = await fetch('/api/groups/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (res.ok) {
                showResult('groupResult', `‚úÖ Group created! ID: ${result.group.id}`, false);
            } else {
                showResult('groupResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function listGroups() {
            if (!token) {
                showResult('groupResult', '‚ùå Please login first', true);
                return;
            }
            
            const res = await fetch('/api/groups', {
                method: 'GET',
                headers: { 'Authorization': token }
            });
            
            const result = await res.json();
            const list = document.getElementById('groupList');
            if (res.ok) {
                list.innerHTML = '<h4>Your Groups:</h4>';
                result.groups.forEach(g => {
                    list.innerHTML += `
                        <div style="border:1px solid #ddd; padding:10px; margin:5px;">
                            <strong>${g.name}</strong><br>
                            ID: ${g.id}<br>
                            Admin-only: ${g.isAdminOnly ? 'Yes' : 'No'}<br>
                            Members: ${g.members.length}
                        </div>
                    `;
                });
            } else {
                showResult('groupResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function toggleAdminOnly() {
            if (!token) return alert('Login first');
            const groupId = document.getElementById('adminGroupId').value;
            
            const res = await fetch(`/api/groups/${groupId}/toggle-admin`, {
                method: 'POST',
                headers: { 'Authorization': token }
            });
            
            const result = await res.json();
            if (res.ok) {
                showResult('groupResult', `‚úÖ ${result.message}`, false);
            } else {
                showResult('groupResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function sendMessage() {
            if (!token) return alert('Login first');
            const groupId = document.getElementById('msgGroupId').value;
            const content = document.getElementById('messageContent').value;
            
            const res = await fetch(`/api/messages/${groupId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ content })
            });
            
            const result = await res.json();
            if (res.ok) {
                showResult('messageResult', `‚úÖ Message sent!`, false);
            } else {
                showResult('messageResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function getMessages() {
            if (!token) return alert('Login first');
            const groupId = document.getElementById('getMsgGroupId').value;
            
            const res = await fetch(`/api/messages/${groupId}`, {
                method: 'GET',
                headers: { 'Authorization': token }
            });
            
            const result = await res.json();
            const list = document.getElementById('messageList');
            if (res.ok) {
                list.innerHTML = '<h4>Messages:</h4>';
                result.messages.forEach(m => {
                    list.innerHTML += `
                        <div style="border:1px solid #ddd; padding:10px; margin:5px;">
                            <strong>From: ${m.sender}</strong><br>
                            ${m.content}<br>
                            <small>${new Date(m.timestamp).toLocaleString()}</small>
                        </div>
                    `;
                });
            } else {
                showResult('messageResult', `‚ùå ${result.error}`, true);
            }
        }
        
        async function checkHealth() {
            const res = await fetch('/api/health');
            const result = await res.json();
            document.getElementById('healthResult').innerHTML = `
                Status: ${result.status}<br>
                Users: ${result.stats.users}<br>
                Groups: ${result.stats.groups}<br>
                Messages: ${result.stats.messages}
            `;
        }
        
        // Check if logged in
        window.onload = () => {
            if (token) {
                showResult('authResult', `‚úÖ Already logged in (Token: ${token.substring(0, 20)}...)`, false);
            }
        };
    </script>
</body>
</html>